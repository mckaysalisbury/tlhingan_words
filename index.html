<html>
    <head>
        <script src="https://github.mckaysalisbury.com/ListBoy/ListBoy.js"></script>
        <style>
            #status {
                position: absolute;
                right: 0;
                bottom: 0;
                color: lightgray;
            }
            .string-default {
                float: left;
            }
            .string-default::after {
                content: "â€ƒ";  /* emspace */
            }
        </style>
        <script>
            const words = {};
            function parsePiece(xhr) {
                // Even still, It should be this easy
                // const document = xhr.responseXML;
                // But they're not valid XML documents, so we need to make it work
                const parser = new DOMParser();
                const xml = parser.parseFromString(`<document>${xhr.responseText}</document>`, "text/xml"); // So I have to wrap it
                return xml;
            }

            function extractWords(xml) {
                const tables = xml.getElementsByTagName("table");
                for (const table of tables) {
                    const columns = table.getElementsByTagName("column");
                    let entry_name = null;
                    let definition = null;
                    for (column of columns) {
                        const name = column.getAttribute("name");
                        switch (name) {
                            case "entry_name":
                                entry_name = column.getInnerHTML();
                                break;
                            case "definition":
                                definition = column.getInnerHTML();
                                break;
                            default:
                                // do nothing, we don't care about this
                        }
                        // if (entry_name && definition) { // optimization
                        //     break;
                        // }
                    }
                    words[entry_name] = definition;
                }
            }

            const vowels = ['a', 'e', 'I', 'o', 'u']
            const consonants = ['b', 'ch', 'D', 'gh', 'H', 'j', 'l', 'm', 'n', 'ng', 'p', 'q', 'Q', 'r', 'S', 't', 'tlh', 'v', 'w', 'y', "'"]

            const files = {
                "b": "01",
                "ch": "02",
                "D": "03",
                "gh": "04",
                "H": "05",
                "j": "06",
                "l": "07",
                "m": "08",
                "n": "09",
                "ng": "10",
                "p": "11",
                "q": "12",
                "Q": "13",
                "r": "14",
                "S": "15",
                "t": "16",
                "tlh": "17",
                "v": "18",
                "w": "19",
                "y": "20",
                "a": "21",
                "e": "22",
                "I": "23",
                "o": "24",
                "u": "25",
                "suffixes": "26",
                "extra": "27",
                "examples": "28",
                "footer": "29",
            }
            const counts = {};
            function update_counter(counter) {
                // This is not thread safe, but it's good enough for what I need.
                counts[counter]++;
                document.getElementById('status').innerHTML = "";
                // ListBoy.RenderTo(counts, 'status');
                console.log("Status", counts)
            }

            function display_dictionary() {
                document.getElementById('words').innerHTML = "";
                ListBoy.RenderTo(words, "words");
            }

            function processFiles() {
                counts.started = 0;
                counts.downloaded = 0;
                counts.processed = 0;
                for (const letter in files) {
                    const xhr = new XMLHttpRequest();
                    xhr.onload = () => {
                        update_counter("downloaded");
                        const xml = parsePiece(xhr);
                        extractWords(xml);
                        counts.words = Object.entries(words).length;
                        update_counter("processed");
                    };

                    xhr.onerror = () => {
                        alert("Error while getting XML.");
                    };

                    const number = files[letter];
                    xhr.open("GET", `https://raw.githubusercontent.com/De7vID/klingon-assistant-data/master/mem-${number}-${letter}.xml`, true);
                    update_counter("started");
                    // xhr.responseType = "document"; These aren't valid XML documents :(
                    xhr.send();
                }
                syllableWords.length = 0;
                getAllSyllableWords();
                counts.syllables = syllableWords.length;
            }

            //      <consonant><vowel> |
            //      <consonant><vowel><consonant> |
            //      <consonant><vowel>"w" "'" |
            //      <consonant><vowel>"y" "'" |
            //      <consonant><vowel>"r" "gh"
            const syllableWords = []

            function* twoCharacterWords() {
                for (const consonant of consonants) {
                    for (const vowel of vowels) {
                        yield consonant + vowel;
                    }
                }
            }

            function* threeCharacterWords() {
                for (const leadingConsonant of consonants) {
                    for (const vowel of vowels) {
                        for (const closingConsonant of consonants) {
                            yield leadingConsonant + vowel + closingConsonant;
                        }
                    }
                }
            }

            function* fourCharacterWords() {
                const extraPieces = ["w'", "y'", 'rgh']
                for (const piece of extraPieces) {
                    for (const word of twoCharacterWords()) {
                        yield word + piece;
                    }
                }
            }

            function getAllSyllableWords() {
                syllableWords.push(...twoCharacterWords(), ...threeCharacterWords(), ...fourCharacterWords())
            }

            function* missing_words() {
                for(const possible of syllableWords) {
                    if (possible in words) {
                        // do nothing?
                    } else {
                        yield possible;
                    }
                }
            }

            function display_missing() {
                document.getElementById('words').innerHTML = "";
                const missing = Array.from(missing_words());
                console.log("Missing Words", missing.length)
                ListBoy.RenderTo(missing, 'words');
            }
        </script>
    </head>
    <body>
        <!-- <button onclick="processFiles();">Process</button> -->
        <!-- <button onclick="display_dictionary();">Display Dictionary</button> -->
        <button onclick="display_missing();">Display Missing Words</button>
        <div id="status"></div><div id="words"></div>
    </body>
    <script>
        processFiles();
    </script>
</html>
